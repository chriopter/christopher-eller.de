{{ define "main" }}
<style>
/* Override main content width for photo pages */
main {
    max-width: 1400px !important;
}

/* Force dark mode styles regardless of theme */
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    background-color: #000 !important;
    color: #eee !important;
}

/* Single photo: lock viewport on desktop only */
@media (min-width: 1200px) {
    .single-photo-body {
        height: 100vh;
        overflow: hidden;
    }
}

/* Multi-photo: allow scrolling */
.multi-photo-body {
    height: auto;
    overflow: auto;
}

header {
    display: none !important;
}

.site-title,
.nav-links a {
    color: #eee !important;
}

footer {
    display: none !important;
}

footer a {
    color: #999 !important;
}

main {
    padding-top: 0 !important;
}


.photo-container {
    max-width: 100vw;
    margin: 0 auto;
    box-sizing: border-box;
    padding: 0;
    display: flex;
    align-items: center;
    min-height: 100vh;
}

.photo-main {
    display: grid;
    grid-template-columns: 1fr;
    gap: 36px;
    margin: 0;
    align-items: center;
    width: 100%;
    min-height: 100vh;
}

@media (min-width: 1200px) {
    .photo-main {
        grid-template-columns: minmax(0, 3fr) minmax(350px, 1.1fr);
        gap: 48px;
        padding: 40px 80px;
        margin: 0 auto;
        max-width: calc(100vw - 120px);
    }
}

.photo-main img {
    width: 100%;
    max-height: 90vh;
    object-fit: contain;
}

.photo-main > div:first-child {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 0 40px 24px;
    box-sizing: border-box;
}

.photo-hero {
    flex: 1;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
}
.photo-hero img {
    max-height: 90vh;
    max-width: 100%;
    object-fit: contain;
}

@media (min-width: 1200px) {
    .photo-hero img {
        max-height: 85vh;
    }
}

@media (max-width: 1199px) { .photo-main img { max-height: none; height: auto; margin: 10px 0; } }

.photo-info {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    right: 80px;
    width: 350px;
    text-align: left;
    padding: 0 20px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 18px;
    max-height: 80vh;
    overflow-y: hidden;
}

@media (max-width: 1199px) {
    html, body { overflow: auto; height: auto; }
    .photo-info { position: static; transform: none; right: auto; width: auto; max-width: none; text-align: center; padding: 10px 16px; gap: 12px; max-height: none; overflow: visible; }
    .photo-main { padding: 10px 10px 16px; gap: 10px; }
    .photo-main > div:first-child { padding: 0 16px 16px; }
    .photo-hero { padding: 0 16px; }
    .photo-nav.prev, .photo-nav.next { position: static; transform: none; }
}

.photo-title {
    font-size: 24px;
    margin: 0;
    padding: 0;
    line-height: 1;
    cursor: default;
    display: flex;
    align-items: baseline;
    gap: 10px;
}

.photo-number {
    font-size: 18px;
    color: #666;
    font-weight: normal;
}

.date-container {
    height: 20px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    color: #999;
    font-size: 14px;
    position: relative;
}

.photo-date {
    transition: opacity 0.2s ease;
}

.upload-date-inline {
    position: absolute;
    left: 0;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.date-separator {
    color: rgba(255, 255, 255, 0.3);
    margin: 0 4px;
}

.full-size-inline {
    color: rgba(255, 255, 255, 0.5);
    text-decoration: none;
    font-size: 14px;
    transition: color 0.2s ease;
    position: relative;
    z-index: 10;
}

.full-size-inline:hover {
    color: rgba(255, 255, 255, 0.8);
}

.photo-title:hover ~ .date-container .photo-date {
    display: none;
}

.photo-title:hover ~ .date-container .upload-date-inline {
    position: static;
    opacity: 1;
}

.photo-metadata {
    font-size: 14px;
    color: #999;
}

.photo-metadata p {
    margin: 5px 0;
    display: flex;
    align-items: center;
}

.photo-metadata p:before {
    font-size: 16px;
    margin-right: 6px;
}

.back-to-gallery-btn {
    color: #999;
    text-decoration: underline;
    font-size: 14px;
    transition: color 0.2s ease;
    text-underline-offset: 2px;
}

.back-to-gallery-btn:hover {
    color: #fff;
}

.photo-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    color: #fff;
    text-decoration: none;
    padding: 15px;
    border-radius: 5px;
    transition: opacity 0.2s ease;
    display: flex;
    align-items: center;
    z-index: 10;
}

.photo-nav:hover { opacity: 0.8; }

.nav-container {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transform: translateY(-50%);
    pointer-events: none;
}

.nav-container .photo-nav { pointer-events: auto; }

/* Remove old fixed arrow styles */
.photo-nav.prev, .photo-nav.next { display: none; }

.photo-nav-arrow {
    font-size: 24px;
}

@media (max-width: 1199px) {
    .photo-container {
        flex-direction: column;
        align-items: center;
        padding: 20px 0 100px;
    }

    .photo-nav {
        position: relative;
        top: auto;
        left: auto;
        right: auto;
        transform: none;
        margin: 0;
        display: inline-block;
        padding: 12px;
        min-width: 44px;
        text-align: center;
        background: transparent;
        backdrop-filter: none;
    }

    .photo-main {
        padding: 20px 15px 60px;
        gap: 20px;
    }

    .nav-container { position: static; background: transparent; backdrop-filter: none; padding: 0 12px; margin: 0; display: flex; justify-content: space-between; align-items: center; width: 100%; }

    .nav-container:empty {
        display: none;
    }

    .nav-container:has(.photo-nav:only-child) {
        justify-content: flex-end;
    }

    .nav-container:has(.photo-nav.prev:only-child) {
        justify-content: flex-start;
    }
}

@media (max-width: 768px) {
    .photo-nav { padding: 8px; }
    .photo-nav-arrow { font-size: 20px; }
}

.full-size-link {
    display: inline-block;
    margin-top: 20px;
    color: rgba(255, 255, 255, 0.5);
    text-decoration: none;
    font-size: 12px;
    transition: all 0.2s ease;
}

.full-size-link:hover {
    color: rgba(255, 255, 255, 0.8);
}

/* Navigation buttons under EXIF */
.photo-nav-desktop {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 30px;
    justify-content: flex-start;
    width: 100%;
}

@media (max-width: 1199px) {
    .photo-nav-desktop {
        justify-content: center;
        margin-top: 20px;
        padding: 10px 0;
    }
}

.photo-nav-btn {
    background: transparent;
    color: #999;
    text-decoration: none;
    padding: 0;
    transition: color 0.2s ease;
    display: inline-flex;
    align-items: center;
    font-size: 18px;
    font-weight: 700;
    line-height: 1;
    border: none;
}

.photo-nav-btn:hover {
    color: #fff;
}

.photo-nav-btn.disabled {
    color: #444;
    cursor: not-allowed;
}

.nav-separator {
    color: #666;
    margin: 0 4px;
}

/* Horizontal strip for multi-image posts */
.photo-stack { display: flex; flex-direction: column; gap: 24px; }

/* (old thumbnails grid removed) */

.photo-extra { display: block; border-radius: 8px; overflow: hidden; height: 110px; }

.photo-extra img { width: 100%; height: 100%; object-fit: cover; display: block; }
</style>

{{ $currentPage := . }}
{{/* Build EXIF for inline mobile use as well */}}
{{ $photos := where .Site.RegularPages "Section" "photos" }}
{{ range $index, $page := $photos }}
    {{ if eq $page $currentPage }}
        {{ $prevIndex := sub $index 1 }}
        {{ $nextIndex := add $index 1 }}
        {{ with $photos }}
            {{ if ge $prevIndex 0 }}
                {{ $prevPage := index . $prevIndex }}
                {{ $.Scratch.Set "prevPage" $prevPage }}
            {{ end }}
            {{ if lt $nextIndex (len .) }}
                {{ $nextPage := index . $nextIndex }}
                {{ $.Scratch.Set "nextPage" $nextPage }}
            {{ end }}
        {{ end }}
    {{ end }}
{{ end }}

<div class="photo-container">
    <div class="photo-main" id="photo-main">
        <div>
            {{ $images := .Resources.Match "*.{jpg,jpeg,png,gif,heic,heif}" }}
            {{ if gt (len $images) 1 }}
            {{/* Multi-image: vertical stack of full-size photos with scroll-based EXIF */}}
            {{ $first := index $images 0 }}
            {{ with $first.Exif }}{{ $.Scratch.Set "exif" . }}{{ end }}
            <div class="photo-stack" data-multi-photo="true">
                {{ range $i, $img := $images }}
                    {{ if eq $img.MediaType.MainType "image" }}
                        {{ $display := $img }}
                        {{ if not (or (eq $img.MediaType.SubType "heif") (eq $img.MediaType.SubType "heic")) }}
                            {{ $display = $img.Resize "1600x" }}
                        {{ end }}
                        <a class="photo-item" href="{{ $img.RelPermalink }}" target="_blank"
                           data-index="{{ $i }}"
                           data-fullsize="{{ $img.RelPermalink }}"
                           {{ with $img.Exif }}
                               {{ with .Tags.Model }}data-model="{{ . }}"{{ end }}
                               {{ with .Tags.LensModel }}data-lens="{{ if $img.Exif.Tags.Model }}{{ replaceRE (printf "%s ?(.+)" $img.Exif.Tags.Model) "$1" . }}{{ else }}{{ . }}{{ end }}"{{ end }}
                               {{ with .Tags.DateTimeOriginal }}
                                   {{ $dateStr := . }}
                                   {{ $dateStr := replaceRE "^([0-9]{4}):([0-9]{2}):([0-9]{2})" "$1-$2-$3" $dateStr }}
                                   {{ $dateStr := replaceRE ":([0-9]{2}):([0-9]{2})" " $1:$2" $dateStr }}
                                   {{ $dateStr := replaceRE " ([0-9]{2}) ([0-9]{2}):([0-9]{2})" " $1:$2:$3" $dateStr }}
                                   {{ $parsedDate := time $dateStr }}
                                   data-date="{{ $parsedDate.Format "2. January 2006" }}"
                               {{ end }}
                               data-settings="{{ with .Tags.FocalLength }}{{ $focalNum := float . }}{{ printf "%.0f" $focalNum }}mm{{ with $img.Exif.Tags.FocalLengthIn35mmFormat }} ({{ . }}mm){{ end }}{{ end }}{{ with .Tags.FNumber }}{{ $fnum := . }}{{ $fnumFloat := float $fnum }} • ƒ/{{ printf "%.1f" $fnumFloat }}{{ end }}{{ with .Tags.ExposureTime }}{{ if . }}{{ $parts := split . "/" }}{{ if eq (len $parts) 2 }}{{ $numerator := index $parts 0 }}{{ $denominator := index $parts 1 }}{{ $denominator := div (float $denominator) (float $numerator) }}{{ $roundedDenominator := math.Round $denominator }} • 1/{{ $roundedDenominator }}s{{ else }} • {{ . }}s{{ end }}{{ end }}{{ end }}{{ with .Tags.ISO }} • ISO {{ . }}{{ else }}{{ with .Tags.ISOSpeedRatings }} • ISO {{ . }}{{ end }}{{ end }}"
                           {{ end }}>
                            <img src="{{ $display.RelPermalink }}" alt="{{ $currentPage.Title }}" {{ if eq $i 0 }}loading="eager"{{ else }}loading="lazy"{{ end }} />
                        </a>
                    {{ end }}
                {{ end }}
            </div>
            {{ else }}
            {{/* Single image: classic hero */}}
            <div class="photo-hero">
                {{ range first 1 $images }}
                    {{ $image := . }}
                    {{ if eq $image.MediaType.MainType "image" }}
                        {{ with $image.Exif }}{{ $.Scratch.Set "exif" . }}{{ end }}
                        {{ $hero := $image }}
                        {{ if not (or (eq $image.MediaType.SubType "heif") (eq $image.MediaType.SubType "heic")) }}
                            {{ $hero = $image.Resize "1600x" }}
                        {{ end }}
                        <a href="{{ $image.RelPermalink }}" class="photo-item" target="_blank">
                            <img src="{{ $hero.RelPermalink }}" alt="{{ $currentPage.Title }}" loading="eager" />
                        </a>
                    {{ end }}
                {{ end }}
            </div>
            {{ end }}
            
            <div class="nav-container">
                {{ with $.Scratch.Get "prevPage" }}
                <a href="{{ .RelPermalink }}" class="photo-nav prev" title="{{ .Title }}">
                    <span class="photo-nav-arrow">←</span>
                </a>
                {{ end }}
                
                {{ with $.Scratch.Get "nextPage" }}
                <a href="{{ .RelPermalink }}" class="photo-nav next" title="{{ .Title }}">
                    <span class="photo-nav-arrow">→</span>
                </a>
                {{ end }}
            </div>

            {{/* extras removed in favor of stacked photos */}}
        </div>
        
        <div class="photo-info">
            <h1 class="photo-title">{{ .Title }} <span id="photo-number" class="photo-number"></span></h1>
            {{ $exif := $.Scratch.Get "exif" }}
            <div class="date-container">
                {{ if $exif }}
                    {{ with $exif.Tags.DateTimeOriginal }}
                        {{ $dateStr := . }}
                        {{ $dateStr := replaceRE "^([0-9]{4}):([0-9]{2}):([0-9]{2})" "$1-$2-$3" $dateStr }}
                        {{ $dateStr := replaceRE ":([0-9]{2}):([0-9]{2})" " $1:$2" $dateStr }}
                        {{ $dateStr := replaceRE " ([0-9]{2}) ([0-9]{2}):([0-9]{2})" " $1:$2:$3" $dateStr }}
                        {{ $parsedDate := time $dateStr }}
                        <span class="photo-date">{{ $parsedDate.Format "2. January 2006" }}</span>
                    {{ end }}
                {{ end }}
                <span class="upload-date-inline">Uploaded on {{ .Date.Format "2. January 2006" }}</span>
                <span class="date-separator"> • </span>
                <a href="{{ (index $images 0).RelPermalink }}" id="full-size-link" class="full-size-inline" target="_blank">Full Size ↗</a>
            </div>
            <div class="photo-metadata">
                {{ if $exif }}
                    {{ with $exif.Tags.Model }}
                    <p id="exif-model">📷 {{ . }}</p>
                    {{ end }}

                    <p id="exif-settings">⚙️ {{ with $exif.Tags.FocalLength }}{{ $focalNum := float . }}{{ printf "%.0f" $focalNum }}mm{{ with $exif.Tags.FocalLengthIn35mmFormat }} ({{ . }}mm){{ end }}{{ end }}{{ with $exif.Tags.FNumber }}{{ $fnum := . }}{{ $fnumFloat := float $fnum }} • ƒ/{{ printf "%.1f" $fnumFloat }}{{ end }}{{ with $exif.Tags.ExposureTime }}{{ if . }}{{ $parts := split . "/" }}{{ if eq (len $parts) 2 }}{{ $numerator := index $parts 0 }}{{ $denominator := index $parts 1 }}{{ $denominator := div (float $denominator) (float $numerator) }}{{ $roundedDenominator := math.Round $denominator }} • 1/{{ $roundedDenominator }}s{{ else }} • {{ . }}s{{ end }}{{ end }}{{ end }}{{ with $exif.Tags.ISO }} • ISO {{ . }}{{ else }}{{ with $exif.Tags.ISOSpeedRatings }} • ISO {{ . }}{{ end }}{{ end }}
                    </p>

                    {{ if $exif.Tags.LensModel }}
                    <p id="exif-lens">🔭 {{ if $exif.Tags.Model }}{{ replaceRE (printf "%s ?(.+)" $exif.Tags.Model) "$1" $exif.Tags.LensModel }}{{ else }}{{ $exif.Tags.LensModel }}{{ end }}</p>
                    {{ else }}
                    <p id="exif-lens" style="opacity: 0;">🔭</p>
                    {{ end }}
                {{ end }}

            </div>

            {{/* extras moved under hero (left column) */}}

            <div class="photo-nav-desktop">
                {{ with $.Scratch.Get "prevPage" }}
                <a href="{{ .RelPermalink }}" class="photo-nav-btn prev" title="{{ .Title }}"><</a>
                {{ else }}
                <span class="photo-nav-btn disabled"><</span>
                {{ end }}

                {{ with $.Scratch.Get "nextPage" }}
                <a href="{{ .RelPermalink }}" class="photo-nav-btn next" title="{{ .Title }}">></a>
                {{ else }}
                <span class="photo-nav-btn disabled">></span>
                {{ end }}

                <a href="/" class="back-to-gallery-btn">Gallery</a>
            </div>
            </div>
        </div>
</div>

<script>
// Add body class for single/multi photo
{{ $images := .Resources.Match "*.{jpg,jpeg,png,gif,heic,heif}" }}
{{ if gt (len $images) 1 }}
document.body.classList.add('multi-photo-body');
{{ else }}
document.body.classList.add('single-photo-body');
{{ end }}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
        const prevLink = document.querySelector('.photo-nav.prev');
        if (prevLink) window.location.href = prevLink.href;
    }
    if (e.key === 'ArrowRight') {
        const nextLink = document.querySelector('.photo-nav.next');
        if (nextLink) window.location.href = nextLink.href;
    }
});

// Update EXIF on scroll for multi-photo posts
if (document.querySelector('.photo-stack[data-multi-photo="true"]')) {
  const photos = document.querySelectorAll('.photo-stack .photo-item');
  const totalPhotos = photos.length;

  function updateExif() {
    const windowCenter = window.innerHeight / 2;

    let currentPhoto = null;
    let currentIndex = 0;
    let minDistance = Infinity;

    photos.forEach((photo, index) => {
      const rect = photo.getBoundingClientRect();
      const photoCenter = rect.top + rect.height / 2;
      const distance = Math.abs(photoCenter - windowCenter);

      if (distance < minDistance) {
        minDistance = distance;
        currentPhoto = photo;
        currentIndex = index;
      }
    });

    if (currentPhoto) {
      const date = currentPhoto.dataset.date;
      const model = currentPhoto.dataset.model;
      const lens = currentPhoto.dataset.lens;
      const settings = currentPhoto.dataset.settings;
      const fullsize = currentPhoto.dataset.fullsize;

      const dateEl = document.querySelector('.photo-date');
      const modelEl = document.getElementById('exif-model');
      const settingsEl = document.getElementById('exif-settings');
      const lensEl = document.getElementById('exif-lens');
      const fullsizeEl = document.getElementById('full-size-link');
      const numberEl = document.getElementById('photo-number');

      if (dateEl && date) dateEl.textContent = date;
      if (modelEl) modelEl.innerHTML = model ? '📷 ' + model : '';
      if (settingsEl) settingsEl.innerHTML = settings ? '⚙️ ' + settings : '';
      if (lensEl) {
        if (lens) {
          lensEl.innerHTML = '🔭 ' + lens;
          lensEl.style.opacity = '1';
        } else {
          lensEl.innerHTML = '🔭';
          lensEl.style.opacity = '0';
        }
      }
      if (fullsizeEl && fullsize) fullsizeEl.href = fullsize;
      if (numberEl) numberEl.textContent = `${currentIndex + 1} / ${totalPhotos}`;
    }
  }

  window.addEventListener('scroll', updateExif);
  updateExif(); // Initial update
}

// Basic swipe navigation on touch devices
(function() {
  let startX = 0, startY = 0, startTime = 0;
  const threshold = 50; // px
  const restraint = 80; // allow some vertical movement
  const allowedTime = 500; // ms

  window.addEventListener('touchstart', function(e) {
    const t = e.changedTouches[0];
    startX = t.pageX; startY = t.pageY; startTime = Date.now();
  }, { passive: true });

  window.addEventListener('touchend', function(e) {
    const t = e.changedTouches[0];
    const distX = t.pageX - startX;
    const distY = t.pageY - startY;
    const elapsed = Date.now() - startTime;
    if (elapsed <= allowedTime && Math.abs(distX) >= threshold && Math.abs(distY) <= restraint) {
      if (distX < 0) {
        const nextLink = document.querySelector('.photo-nav.next');
        if (nextLink) window.location.href = nextLink.href;
      } else {
        const prevLink = document.querySelector('.photo-nav.prev');
        if (prevLink) window.location.href = prevLink.href;
      }
    }
  }, { passive: true });
})();
</script>
{{ end }}
